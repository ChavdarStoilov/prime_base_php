<?php
use PHPUnit\Framework\TestCase;
use Nyholm\Psr7\Factory\ServerRequestFactory;
use Nyholm\Psr7\Factory\StreamFactory;

final class AuthPenTest extends TestCase
{
    private $app;

    protected function setUp(): void
    {
        $bootstrap = require __DIR__ . '/../integration/Bootstrap.php';
        $this->app = $bootstrap['app'];
    }

    public function testLoginWithSqlInjection(): void
    {
        $body = ['username' => "' OR 1=1 --", 'password' => 'anything'];
        $request = (new ServerRequestFactory())
            ->createServerRequest('POST', '/api/v1/auth/login')
            ->withBody((new StreamFactory())->createStream(json_encode($body)))
            ->withHeader('Content-Type', 'application/json');

        $response = $this->app->handle($request);
        $this->assertEquals(401, $response->getStatusCode());
    }

    public function testAccessWithoutPermission(): void
    {
        $jwtService = (require __DIR__ . '/../integration/Bootstrap.php')['jwt'];
        $token = $jwtService->generate([
            'sub' => '11111111-1111-1111-1111-111111111111',
            'permissions' => [] // няма права
        ]);

        $request = (new ServerRequestFactory())
            ->createServerRequest('GET', '/api/v1/users')
            ->withHeader('Authorization', "Bearer $token");

        $response = $this->app->handle($request);
        $this->assertEquals(403, $response->getStatusCode());
    }
}
