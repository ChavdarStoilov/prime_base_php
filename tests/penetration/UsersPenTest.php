<?php
// tests/penetration/UsersPenTest.php

use PHPUnit\Framework\TestCase;
use Slim\Psr7\Factory\ServerRequestFactory;
use Slim\Psr7\Factory\StreamFactory;

class UsersPenTest extends TestCase
{
    private $app;
    private $jwtToken;

    protected function setUp(): void
    {
        $this->app = require __DIR__ . '/Bootstrap.php';

        // Генерираме тестов JWT (mock или реален)
        $this->jwtToken = 'Bearer ' . getenv('TEST_JWT') ?? 'mocked_jwt_for_tests';
    }

    public function testListUsersUnauthorized(): void
    {
        $request = (new ServerRequestFactory())->createServerRequest('GET', '/api/v1/users');
        $response = $this->app->handle($request);

        $this->assertEquals(401, $response->getStatusCode());
    }

    public function testListUsersSuccess(): void
    {
        $request = (new ServerRequestFactory())->createServerRequest('GET', '/api/v1/users')
            ->withHeader('Authorization', $this->jwtToken);

        $response = $this->app->handle($request);
        $data = json_decode((string)$response->getBody(), true);

        $this->assertEquals(200, $response->getStatusCode());
        $this->assertArrayHasKey('data', $data);
        $this->assertIsArray($data['data']);
    }

    public function testGetUserInvalidUuid(): void
    {
        $request = (new ServerRequestFactory())->createServerRequest('GET', '/api/v1/users/invalid-uuid')
            ->withHeader('Authorization', $this->jwtToken);

        $response = $this->app->handle($request);
        $data = json_decode((string)$response->getBody(), true);

        $this->assertEquals(400, $response->getStatusCode());
        $this->assertStringContainsString('Invalid id format', $data['data']['message']);
    }

    // TODO: добави тестове за RBAC
    // Например user без "delete_user" permission опитва DELETE → 403 Unauthorized
}
